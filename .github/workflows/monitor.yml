name: Yonyou HK Listing Monitor

on:
  # 定时执行：每2小时检查一次
  schedule:
    - cron: '0 */2 * * *'

  # 手动触发（支持测试模式）
  workflow_dispatch:
    inputs:
      test_mode:
        description: 'Test mode (send test notification)'
        required: false
        type: boolean
        default: false

  # 推送主分支时触发（可选）
  push:
    branches: [main, master]
    paths:
      - 'src/**'
      - 'requirements.txt'
      - '.github/workflows/**'

jobs:
  monitor:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      # 设置 Python 环境
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'
          cache: 'pip'

      # 安装依赖
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      # 从 GitHub Secrets 读取配置
      - name: Export environment variables
        run: |
          echo "TELEGRAM_BOT_TOKEN=${{ secrets.TELEGRAM_BOT_TOKEN }}" >> $GITHUB_ENV
          echo "TELEGRAM_CHAT_ID=${{ secrets.TELEGRAM_CHAT_ID }}" >> $GITHUB_ENV
          echo "DATA_DIR=./data" >> $GITHUB_ENV
          echo "TEST_MODE=${{ github.event.inputs.test_mode == 'true' }}" >> $GITHUB_ENV

      # 测试模式：跳过数据恢复
      - name: Restore historical data
        if: github.event.inputs.test_mode != 'true'
        continue-on-error: true
        uses: actions/download-artifact@v4
        with:
          name: monitor-data
          path: ./data

      # 运行监控脚本
      - name: Run monitor
        run: |
          mkdir -p ./data
          python src/monitor.py

      # 上传 data 文件作为 artifact（用于下次运行去重）
      - name: Upload data for next run
        uses: actions/upload-artifact@v4
        with:
          name: monitor-data
          path: ./data
          retention-days: 90

      # 可选：提交 data 文件回仓库（作为备份）
      - name: Commit data to repo
        continue-on-error: true
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"
          git add data/
          git diff --quiet && git diff --staged --quiet || git commit -m "[skip ci] Update monitor data"
          git push
